# Database Migrations

This directory contains database migrations for the CCC Landing Page project.

## Migration Files

- `20240222_create_development_schema.sql`: Creates the development schema and sets up permissions
- `20240223_004_recreate_sponsors.sql`: Creates the sponsors and sponsor_levels tables
- `20250227_140535_fix_sponsor_permissions.sql`: Fixes permissions for the sponsors table
- `20250227183244_consolidated_sponsor_website_fix.sql`: Consolidated migration that adds website column to sponsors table and fixes migration history

## Migration Naming Convention

Migration files should follow the format:
```
<timestamp>_<descriptive_name>.sql
```

Always use the full timestamp format generated by the Supabase CLI (e.g., `20250227183244_add_column.sql`). This ensures proper ordering and tracking of migrations.

## Migration Best Practices

1. **Make Migrations Idempotent**: Use conditional logic (IF EXISTS, IF NOT EXISTS) to ensure migrations can be run multiple times without errors.
2. **One Change, One Migration**: Each logical change should have its own migration file.
3. **Include Permissions**: When creating new tables or columns, include appropriate permissions and RLS policies.
4. **Test Locally First**: Always test migrations locally before pushing to remote environments.
5. **Use DO Blocks for Complex Logic**: For complex migrations, use DO blocks to encapsulate logic.

Example of an idempotent migration:
```sql
-- Add a new column
DO $$ 
BEGIN 
  IF NOT EXISTS (
    SELECT FROM information_schema.columns 
    WHERE table_schema = 'api' 
    AND table_name = 'my_table' 
    AND column_name = 'new_column'
  ) THEN
    ALTER TABLE api.my_table ADD COLUMN new_column text;
  END IF;
END $$;
```

## Schema Strategy

We use different schemas for different environments:

- `api`: Main schema for our application data
- `public`: System tables and functions
- `supabase_migrations`: Migration history tracking

## Automated Deployments

Migrations are automatically deployed via GitHub Actions when:

1. Changes are pushed to the `main` branch (deploys to production)
2. Changes are pushed to `feature/*` branches (deploys to preview environment)
3. Pull requests are created that include migration changes (validation only)

The workflow is defined in `.github/workflows/supabase-deploy.yml`.

## Local Development

For local development, you can use the Supabase CLI:

```bash
# Create a new migration
supabase migration new <descriptive_name>

# Apply migrations locally
supabase db reset

# Check migration status
supabase migration list

# Compare local and remote migrations
supabase migration list --db-only
```

## Troubleshooting

If you encounter issues with migrations:

1. Check the migration history:
   ```bash
   supabase migration list
   supabase migration list --db-only
   ```

2. Verify the schema state:
   ```bash
   supabase db remote psql
   
   # Then in the psql console
   \dt api.*
   \d api.table_name
   ```

3. Repair migration history if needed:
   ```bash
   supabase migration repair --status applied <timestamp>
   ```

For more detailed information, see the [Supabase Migration Strategy](/docs/chores/supabase-migration-strategy.md) document.
